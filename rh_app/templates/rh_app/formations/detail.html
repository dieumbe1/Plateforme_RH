{% extends 'base.html' %}
{% load static %}

{% block title %}{{ formation.titre }} - Détails de la formation{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- En-tête avec actions -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                    <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-journal-text text-primary fs-2"></i>
                    </div>
                </div>
                <div class="flex-grow-1 ms-4">
                    <h1 class="h2 mb-2">{{ formation.titre }}</h1>
                    <div class="d-flex flex-wrap gap-2 align-items-center">
                        <span class="badge
                            {% if formation.statut == 'PROGRAMMEE' %}bg-primary
                            {% elif formation.statut == 'EN_COURS' %}bg-warning
                            {% elif formation.statut == 'TERMINEE' %}bg-success
                            {% elif formation.statut == 'ANNULEE' %}bg-secondary
                            {% endif %} fs-6" style="color: white !important;">
                            <i class="bi
                                {% if formation.statut == 'PROGRAMMEE' %}bi-calendar-check
                                {% elif formation.statut == 'EN_COURS' %}bi-play-circle
                                {% elif formation.statut == 'TERMINEE' %}bi-check-circle
                                {% elif formation.statut == 'ANNULEE' %}bi-x-circle
                                {% endif %} me-1"></i>
                            {{ formation.get_statut_display }}
                        </span>
                        {% if formation.domaine %}
                        <span class="badge bg-light text-dark fs-6" style="color: #212529 !important;">
                            <i class="bi bi-tag me-1"></i>{{ formation.domaine }}
                        </span>
                        {% endif %}
                        <span class="text-muted fs-6" style="color: #212529 !important;">
                            <i class="bi bi-clock me-1"></i>
                            {{ formation.date_debut|date:"d/m/Y" }} - {{ formation.date_fin|date:"d/m/Y" }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-md-end">
            <div class="d-flex flex-column flex-md-row gap-2 justify-content-md-end">
                {% if user.employe.role == 'EMPLOYE' and not est_inscrit and places_disponibles > 0 %}
                <a href="{% url 'inscrire_formation' formation.pk %}" class="btn btn-success">
                    <i class="bi bi-check-circle me-2"></i>S'inscrire
                </a>
                {% elif est_inscrit %}
                <span class="badge bg-success fs-6 p-2">
                    <i class="bi bi-check-lg me-1"></i>Inscrit
                </span>
                {% endif %}
                
                {% if user.is_staff or user.employe.role == 'MANAGER' %}
                <div class="btn-group">
                    <a href="{% url 'modifier_formation' formation.pk %}" class="btn btn-outline-primary">
                        <i class="bi bi-pencil me-2"></i>Modifier
                    </a>
                    <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" 
                            data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="visually-hidden">Actions</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item" href="#">
                                <i class="bi bi-clipboard-check me-2"></i>Gérer les inscriptions
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#">
                                <i class="bi bi-send me-2"></i>Envoyer un rappel
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="#">
                                <i class="bi bi-trash me-2"></i>Supprimer
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Informations principales -->
        <div class="col-lg-8">
            <!-- Description -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-journal-text me-2"></i>Description
                    </h5>
                </div>
                <div class="card-body">
                    <p class="lead mb-0">{{ formation.description|linebreaksbr }}</p>
                </div>
            </div>

            <!-- Détails de la formation -->
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-info-circle me-2"></i>Détails de la formation
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-item mb-3">
                                <label class="form-label text-muted small mb-1">Formateur</label>
                                <div class="d-flex align-items-center">
                                    {% if formation.formateur.photo %}
                                    <img src="{{ formation.formateur.photo.url }}" 
                                         alt="{{ formation.formateur.get_full_name }}"
                                         class="rounded-circle me-2" width="40" height="40"
                                         style="object-fit: cover;">
                                    {% else %}
                                    <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2" 
                                         style="width: 40px; height: 40px;">
                                        <span class="text-white small">
                                            {{ formation.formateur.get_full_name|first|upper }}
                                        </span>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <div class="fw-semibold">{{ formation.formateur.get_full_name }}</div>
                                        {% if formation.formateur.specialite %}
                                        <small class="text-muted">{{ formation.formateur.specialite }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="info-item mb-3">
                                <label class="form-label text-muted small mb-1">Lieu</label>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-geo-alt text-primary me-2"></i>
                                    <span>{{ formation.lieu }}</span>
                                </div>
                            </div>

                            <div class="info-item mb-3">
                                <label class="form-label text-muted small mb-1">Coût</label>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-currency-euro text-success me-2"></i>
                                    <span>
                                        {% if formation.cout %}
                                            {{ formation.cout }} €
                                        {% else %}
                                            <span class="text-muted">Gratuit</span>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-item mb-3">
                                <label class="form-label text-muted small mb-1">Période</label>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-calendar-event text-primary me-2"></i>
                                    <div>
                                        <div class="fw-semibold">{{ formation.date_debut|date:"d/m/Y" }}</div>
                                        <small class="text-muted">au {{ formation.date_fin|date:"d/m/Y" }}</small>
                                    </div>
                                </div>
                            </div>

                            <div class="info-item mb-3">
                                <label class="form-label text-muted small mb-1">Horaires</label>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-clock text-primary me-2"></i>
                                    <span>
                                        {% if formation.heure_debut and formation.heure_fin %}
                                            {{ formation.heure_debut|time:"H:i" }} - {{ formation.heure_fin|time:"H:i" }}
                                        {% else %}
                                            <span class="text-muted">Non spécifié</span>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>

                            <div class="info-item mb-3">
                                <label class="form-label text-muted small mb-1">Durée</label>
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-hourglass-split text-primary me-2"></i>
                                    <span>
                                        {% if formation.duree %}
                                            {{ formation.duree }} heures
                                        {% else %}
                                            <span class="text-muted">Non spécifiée</span>
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar avec statistiques -->
        <div class="col-lg-4">
            <!-- Capacité et inscription -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-people me-2"></i>Participants
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="d-flex justify-content-center align-items-center mb-3">
                            <div class="position-relative" style="width: 120px; height: 120px;">
                                <svg width="120" height="120" viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" fill="none" stroke="#e9ecef" stroke-width="8"/>
                                    <circle cx="60" cy="60" r="54" fill="none"
                                            stroke="{% if taux_remplissage >= 90 %}#dc3545{% elif taux_remplissage >= 75 %}#ffc107{% else %}#198754{% endif %}"
                                            stroke-width="8" stroke-dasharray="339.292"
                                            stroke-dashoffset="{{ taux_remplissage|floatformat:0|add:'-100'|stringformat:'f'|cut:'-' }}"/>
                                </svg>
                                <div class="position-absolute top-50 start-50 translate-middle text-center">
                                    <div class="h4 mb-0 fw-bold">{{ taux_remplissage }}%</div>
                                    <small class="text-muted">remplissage</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row text-center">
                            <div class="col-12">
                                <div class="h5 mb-1 fw-bold text-primary">{{ formation.inscriptions.count }}</div>
                                <small class="text-muted">Inscrits</small>
                            </div>
                        </div>
                    </div>

                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar
                            {% if taux_remplissage >= 90 %}bg-danger
                            {% elif taux_remplissage >= 75 %}bg-warning
                            {% else %}bg-success{% endif %}"
                             style="width: {{ taux_remplissage }}%">
                        </div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted">
                        <span>0</span>
                        <span>Illimité</span>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- Liste des participants -->
    {% if formation.inscriptions.exists %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-people-fill me-2"></i>Participants inscrits
                        <span class="badge bg-primary ms-2">{{ formation.inscriptions.count }}</span>
                    </h5>
                    {% if user.is_staff %}
                    <button class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-download me-1"></i>Exporter
                    </button>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="ps-4">Participant</th>
                                    <th>Département</th>
                                    <th>Date d'inscription</th>
                                    <th>Statut</th>
                                    {% if user.is_staff %}
                                    <th class="text-end pe-4">Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for inscription in formation.inscriptions.all %}
                                <tr>
                                    <td class="ps-4">
                                        <div class="d-flex align-items-center">
                                            {% if inscription.employe.photo %}
                                            <img src="{{ inscription.employe.photo.url }}" 
                                                 alt="{{ inscription.employe.get_full_name }}"
                                                 class="rounded-circle me-3" width="40" height="40"
                                                 style="object-fit: cover;">
                                            {% else %}
                                            <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center me-3" 
                                                 style="width: 40px; height: 40px;">
                                                <span class="text-white small">
                                                    {{ inscription.employe.get_full_name|first|upper }}
                                                </span>
                                            </div>
                                            {% endif %}
                                            <div>
                                                <div class="fw-semibold">{{ inscription.employe.get_full_name }}</div>
                                                <small class="text-muted">{{ inscription.employe.poste }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">
                                            {{ inscription.employe.departement }}
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ inscription.date_inscription|date:"d/m/Y" }}
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if inscription.statut == 'EN_ATTENTE' %}bg-warning
                                            {% elif inscription.statut == 'APPROUVEE' %}bg-success
                                            {% elif inscription.statut == 'REFUSEE' %}bg-danger
                                            {% elif inscription.statut == 'ANNULEE' %}bg-secondary
                                            {% endif %}">
                                            {{ inscription.get_statut_display }}
                                        </span>
                                    </td>
                                    {% if user.is_staff %}
                                    <td class="text-end pe-4">
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-success" 
                                                    title="Approuver l'inscription">
                                                <i class="bi bi-check-lg"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    title="Refuser l'inscription">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </div>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Styles personnalisés -->
<style>
.card {
    border: none;
    border-radius: 12px;
}
.info-item {
    padding: 8px 0;
}
.badge {
    font-weight: 500;
}
.progress {
    border-radius: 4px;
}
.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
    color: #6c757d;
}
</style>
{% endblock %}